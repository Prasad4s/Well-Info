{% extends 'map/base.html' %}
{% include 'map/base_map.html'%}
{% load static %}
{% block content %}
{% block extra_resources%}
<head>
    <link type="text/css" href="{% static 'home/css/materialize.min.css' %}" rel="stylesheet">
    <script type="text/javascript" src="{% static 'home/js/materialize.min.js' %}"></script>
  
</head>
<style>


#pv label {
    display: block;
    text-align: left;
    margin: 10px;
}
#pv {
    display: none;
}
#wells_district label {
    display: block;
    text-align: left;
    margin: 10px;
}

#wells_district {
    display: none;
}

     .info {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
}
.info h4 {
    margin: 0 0 5px;
    color: #777;
}

table, th, td 
    {
        border-bottom: 1px solid #ddd;
        border-collapse: collapse;
        padding: 2px 3px;
        text-align: center;
    }
    th {
        font-weight:bold;
    }

    .legend {
    line-height: 18px;
    color: #555;
}
.legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
}

.attribute_table {
    line-height: 18px;
    color: #555;
}

.select {
        background-color: rgb(116, 109, 109);
        width: 40%;
        margin-left: 100px;
        ;
        color: white;
    }
    
    .select.highlight {
        background: rgb(0, 0, 0);
        color: white;
    }


    .popupimage {
    height: 200px;
    width: 300px;
    overflow: hidden;
    border-radius: 50px;
}

.popupimage1, .popupimage2, .popupimage3 {
    height: 1250px;
    width: 1000px;
    overflow: hidden;
    border-radius: 20px;
}

#content{
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
#content1{
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
#demo-modal1{
  max-height: 950px;
  width:1025px;
  background-color: transparent;
}    

.border {
        padding: 6px 8px;
        border-style: groove;
        border-radius: 5px;
        margin: 20px;
        background-color: white;
    }

    table,
    th,
    td {
        border-bottom: 1px solid #ddd;
        border-collapse: collapse;
        padding: 2px 3px;
        text-align: center;
    }
    
    th {
        font-weight: bold;
    }
    
    tr:hover {
        background-color: #c9dbe6;
    }
    
    #checkboxes {
        display: none;
        /* border: 1px #dadada solid; */
    }
    
    .slider {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 25px;
        background: #D3D3D3;
        outline: none;
        opacity: 0.7;
        -webkit-transition: .2s;
        transition: opacity .2s;
    }
    
    .slider:hover {
        opacity: 1;
    }
    
    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        background: #FF0000;
        cursor: pointer;
    }
    
    .slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        background: #FF0000;
        cursor: pointer;
    }
    
    .sliderticks {
        display: flex;
        justify-content: space-between;
        padding: 0 10px;
    }
    
    .sliderticks p {
        position: relative;
        display: flex;
        justify-content: center;
        text-align: center;
        width: 1px;
        background: #D3D3D3;
        height: 10px;
        line-height: 40px;
        margin: 0 0 20px 0;
    }
    
    input[type="range"]::-moz-range-track {
        padding: 0 10px;
        background: repeating-linear-gradient(to right, #ccc, #ccc 10%, #000 10%, #000 11%, #ccc 11%, #ccc 20%);
    }
    
    #checkboxes3 label {
        display: block;
        text-align: left;
        margin: 10px;
    }
    
    #checkboxes3 {
        display: none;
        /* border: 1px #dadada solid; */
    }
    
    #checkboxes label {
        display: block;
        text-align: left;
        margin: 10px;
    }
    /* #checkboxes label:hover {
  background-color: #1e90ff;
} */
    
    #checkboxes2 label {
        display: block;
        text-align: left;
        margin: 10px;
    }
    
    #checkboxes2 {
        display: none;
        /* border: 1px #dadada solid; */
    }
    
    .btn {
        margin: 10px;
    }
    
   
    .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }
    
    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }
    
    
    .leaflet-popup-content-wrapper {
        background: rgba(234, 227, 227, 0.9);
        color: #000000;
    }
    
    .leaflet-popup-content {
        font-weight: bold;
    }
    
    h6 {
        color: blue;
    }
    
    .select {
        background-color: rgb(116, 109, 109);
        width: 40%;
        margin-left: 100px;
        ;
        color: white;
    }
    
    .select.highlight {
        background: rgb(0, 0, 0);
        color: white;
    }
    
    .circle {
        background-color: red;
        border-radius: 50%;
    }
    
    .table-legend {
        border-collapse: collapse;
        padding: 2px 3px;
        width: 100%;
        font-size: small;
        /* font-weight: bold; */
        background: #fff;
    }
    
    .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }
    
    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }
    
    .legend {
        line-height: 18px;
        color: #555;
    }
    
    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
</style>
{% endblock %}



<div id="side-bar" style="background-color:white">                <!-- Main container -->

    <!-- rgba(0, 0, 0, 0.2); -->
    <!-- {% if user.groups.all.0.name != "restricted" %} -->
    <!-- <button class = 'btn btn-dark'onclick="downloadLayers()">Download Layer</button> -->
    <!-- <div class="alert alert-info">
        <strong>Info!</strong> Select only single layer to download.
      </div> -->
      <!-- <div class="alert alert-warning">
        <strong>!</strong> Please wait downloading may take some time.
      </div> -->
      <!-- <div style="text-align: center"> 
        <button style="display: inline-block ;position: relative;top: 100px" id="closebutton" name="closebutton" class="btn btn-secondary"><span class="fa fa-power-off"></span></button> 
    </div> -->

    <!-- <div id="queryTab" >
        <button href class="btn btn-primary" type="">Query</button> 
        <button type="button" style="width: 90%;font-size:12px" class="btn btn-outline-dark">Query</button>

        <div class="overSelect"></div>


    </div>
    <br>
    <div id="checkboxes" >
        <div class="checkbox" id="boundary">
            <label><input type="checkbox" value="{admin}" onchange="getBoundaryru(this)"><span> All India View </span></label>
        </div>

    </div>
    <br>
    <div id="queryDiv">
        
        <table id="queryTab">
            <tbody>
                <tr>
                    <td>
                        Layer:
                    </td>
                    <td>
                        <select class="form-control">
                            <option>All India View</option>
                        </select>                        
                    </td>
                </tr>

                <tr>
                    <td>
                        State:
                    </td>
                    <td>
                        <select class="form-control" id="selector">
                            <option>Select State</option>
                            <option value="Maharashtra">Mahatashtra</option>
                            <option>Select State</option>
                            <option>Select State</option>
                        </select>                        
                    </td>
                </tr>
            </tbody>

        </table>

    </div>
    <div>
        <button onclick="getBoundaryru(this)">Submit</button>
    </div> 
    <br>
    <div class="tooltips" id="view">

        <select class='form-control' id="view_s">
              <option value="All"> Select View </option> 
              <option value="All India View">All India View</option>
              <option value="Navigated Area View">Select State</option>
             </select>
    </div>-->
    <br>
    <!--Creating div for navigated area view-->
    <div style="text-align: right"> 
        <button style="display: inline-block ;position: relative;" id="closebutton" name="closebutton" class="btn btn-secondary"><span class="fa fa-power-off"></span></button> 
    </div>
    <div class="border">
        
        <table>
            <tr>
                <h6>Indian Admin Boundaries</h6>
            </tr>
            <div class="text-center">
                <div class="" id="boundary" >
                    <tr>
                        <label><input type="checkbox" value="{state}" style="" onchange="getBoundary(this)"><span > State </span></label>
                    </tr>
                </div>
                <div class="">
                    <label><input type="checkbox" value="{district}" onchange="getBoundary(this)"><span > District </span></label>
                </div>

            </div>
        </table>
    </div>
    <div class="border">
        <table>
            <tr>
                <h6>Wells</h6>
            </tr>
            <div class="text-center">
                <div class="" id="boundary2" >
                    <tr>
                        <label>
                            <!-- <input type="checkbox" value="{Nashik_wells}" style="" onchange="getBoundary(this)"> -->

                            <input type="checkbox" value="{CHC}" onchange="GetSelectedfac(this)">

                            <span > Nashik Wells </span></label>
                        
                    </tr>
                </div>
                <!-- <div class="">
                    <label><input type="checkbox" value="{bhandara}" onchange="getBoundary(this)"><span > District </span></label>
                </div> -->

            </div>
        </table>
    </div>
   <div id="navigatedarea">
    <!--these two dropdowns are dependent-->
     <div class="tooltips" title="Please select the State">
        <!-- onchange="removeposhan();" -->
       <select class='form-control' id="indstate" name="indstate" >
           <option value="All">Select State</option>
           <optgroup label="States"> 
             <option value="Andaman & Nicobar Island">Andaman & Nicobar Island</option>

               <option value="Andhra Pradesh">Andhra Pradesh</option>
               <option value="Arunachal Pradesh" >Arunachal Pradesh</option>
                <option value="Assam" >Assam </option>
               <option value="Bihar" >Bihar</option>
               <option value="Chhattisgarh" >Chhattisgarh</option>
               <option value="Goa" >Goa</option>
               <option value="Gujarat" >Gujarat</option>
               <option value="Haryana" >Haryana</option>
               <option value="Himachal Pradesh" >Himachal Pradesh</option>
               <option value="Jharkhand" >Jharkhand</option>
               <option value="Karnataka" >Karnataka</option>
               <option value="Kerala" >Kerala</option>
               <option value="Madhya Pradesh" >Madhya Pradesh</option>
               <option value="Maharashtra" >Maharashtra</option>
               <option value="Manipur" >Manipur</option>
               <option value="Meghalaya" >Meghalaya</option>
               <option value="Mizoram" >Mizoram</option>
               <option value="Nagaland" >Nagaland</option>
          
 
               <option value="Odisha" >Odisha</option>
               <option value="Punjab" >Punjab</option>
               <option value="Rajasthan" >Rajasthan</option>
               <option value="Sikkim" >Sikkim</option>
               <option value="Tamil Nadu" >Tamil Nadu</option>
               <option value="Telangana" >Telangana</option>
          
 
               <option value="Tripura" >Tripura</option>
               <option value="Uttar Pradesh" >Uttar Pradesh</option>
               <option value="Uttarakhand" >Uttarakhand</option>
               <option value="West Bengal" >West Bengal</option>
               <optgroup label="Union Territories"> 

               <option value="Andaman & Nicobar Islands" >Andaman & Nicobar Islands</option>
               <option value="Chandigarh" >Chandigarh</option>
               <option value="Dadra & Nagar Havelli" >Dadra & Nagar Havelli</option>
               <option value="Daman & Diu" >Daman & Diu</option>
               <option value="Delhi" >Delhi</option>
               <option value="Jammu & Kashmir" >Jammu & Kashmir</option>
               <option value="Ladakh" >Ladakh</option>
               <option value="Lakshadweep" >Lakshadweep</option>
               <option value="Puducherry" >Puducherry</option>
          
   
         </select> 
        </div>

    &nbsp;&nbsp;
    <div class="tooltips" title="Please select the state" id="pv">
        
          <label>
            <!-- <input type="checkbox" value="poshan" id ="chkposhan" onchange="getPoshan(this)"> -->
            <input type="checkbox" value="poshan" id ="chkposhan" >
            <span style="color:black;"><b> Show Wells  </b></span></label>
                           
    </div>


    &nbsp;&nbsp;&nbsp;&nbsp;
    <div class="tooltips" title="Please select the District">
        <select class='form-control' id = "district">
          <option value=""> Select District</option>
         </select>
    </div>

    &nbsp;&nbsp;
    <div class="tooltips" title="Please select the Wells" id="wells_district">
        
          <label><input type="checkbox" value="Wells" id ="chwells" onchange="defineWell(this)"><span style="color:black;"><b> Show Wells  </b></span></label>
                           
    </div>
    
    <div class="tooltips" style="display:none;" title="Please select the Maharashtra's Blocks" id="block">
        &nbsp;&nbsp;
            <select class='form-control' id="block_s">
              <option value=""> Select Taluka </option>
             </select>
      </div>

      &nbsp;&nbsp;&nbsp;&nbsp;
      <div class="tooltips" title="Please select the Pincode">
        <select class='form-control' id="pincode">
<option value=""> Select Pincode</option>
</select>
</div>
<div id="side-bar" style="background-color: rgba(255, 255, 255);">             
    <!-- side-bar container -->
<div class="text-center">



                    <!--Navigated area div ends-->



                    <div class="border">
                        <button type="button" class="btn btn-primary" id='locate'>Your Location</button>
                        <button type="button" class="btn btn-primary" id='setlocation'>Set Location</button>
                        <button type="button" class="btn btn-primary" id='find-nearest'>Find Nearest Facility</button>
                        <div id="slider">
                            <label>Set Range</label><br>
                            <input type="range" min="1" max="50" value="1" class="slider" id="myRange" step="1">
                            <div class="sliderticks">
                                <p>1</p>
                                <p>5</p>
                                <p>10</p>
                                <p>15</p>
                                <p>20</p>
                                <p>25</p>
                                <p>30</p>
                                <p>35</p>
                                <p>40</p>
                                <p>50</p>
                            </div>
                                <button type="button" class="btn btn-primary" id='setbuffer'>Well facilities within <span id="demo"></span> Km </button>
                                <a id="downloadAnchorElem" style="display:none">download</a>

                                <!-- <button type="button" class="btn btn-primary mb-5" onclick=downloadBufferData()>Download </button> -->

                        </div>
                    </div>

                    <!-- <div class="border row">
                        <input type="text" placeholder="Enter facility Name" disabled="" class="form-control col-7" id="usr">
                        <button type="button" class="btn btn-primary col" onclick="searchFacilities()" disabled="">Search Facility</button>
                    </div> -->
<!-- End_line -->

                </div>

<br><br><br><br><br><br><br>


  <!-- Modal Structure -->
  <div id="demo-modal" class="modal bottom-sheet"> 
    <div id="content" class="modal-content"> 
    </div> 
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
      </div>
</div> 

<div id="demo-modal1" class="modal bottom-sheet"> 
  <div class="modal-header" style="text-align: right;">
    <a href="#!" class="modal-close waves-effect waves-green btn-flat" style="color: white; text-align: right; font-weight: bold; font-size: 20px;">X</a>
  </div>
  <div id="content1" class="modal-content"> 
  </div> 
  
</div> 
   

  <!--  <script>
        function layerload(maleg) {
    clearAllLayers();
    if(wms_legend){
    mymap.removeControl(wms_legend);
    } 
    tempParameter = defaultParameters;

    if(maleg === 'bifo'){
    
    mmxlayer = new L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/geonode/ows', {

    layers: 'geonode:inst_bifocals_4may2020',
    format: 'image/png',
    //cql_filter:"govt_poly_=1 or priv_poly_=1" ,
    version: '1.3.0',
    transparent: true,
    });
    mmxlayer.addTo(mymap);
    addWMSLegend(mmxlayer.options.layers);

    LAYER = "https://geoserver2.communitygis.net/geoserver/geonode/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&LAYERS="+mmxlayer.options.layers+"&QUERY_LAYERS="+mmxlayer.options.layers;
    LayerList.push(mmxlayer);


    }
    
    </script> -->

    <iframe id="my_iframe" style="display:none;"></iframe>
    {% endif %}
    {% if user.groups.all.0.name == "restricted" %}
    <div class="alert alert-warning">
        <strong>!</strong> please register to download layers.
      </div>
    {% endif%}



   
           

</div>

<script>
function defineWell(checkbox)
{
    let value = checkbox.value;
    var state = document.getElementById('indstate').value;
    console.log(state);
    console.log(value);
    
    if ($(checkbox).is(':checked')) {
        
        {% for i in wells %}

        var wellIcon = L.icon({
              iconUrl: "{% static 'map/images/well.png' %}",
              iconSize:     [30, 40], // size of the icon
              //shadowSize:   [50, 64], // size of the shadow
              iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
              // shadowAnchor: [4, 62],  // the same for the shadow
              popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
          });
          var wellslayerGroup = L.layerGroup();   

        var table = 
            
            `<table class="w3-table" id="popup" style="font-size:12px; align:center;" >
              <tbody>
            {% if i.picture %}
              <tr>
                <tr><img src={{ i.picture.url }} alt="No image uploaded" style="height:100px; width:170px; border:2px solid #555;"/>
              </tr>
              {% endif %}

              {% if i.name %}
              <tr>
              <th>Information by</th>
              <th>{{ i.name }}</th>
          </tr>
          {% endif %}
    
              {% if i.well_nm %}
              <tr>
                  <th>Well's name</th>
                  <th>{{ i.well_nm }}</th>
              </tr>
              {% endif %}
    
              {% if i.radius %}
              <tr>
                <td>Radius</td>
                <td>{{ i.radius }} mtr</td>
              </tr>
              {% endif %}
    
              {% if i.depth %}
              <tr>
                <td>Depth</td>
                <td>{{ i.depth }} mtr</td>
              </tr>
              {% endif %}
    
              {% if i.level %}
              <tr>
                <td>Level</td>
                <td>{{ i.level }} mtr</td>
              </tr>
              {% endif %}
    
              {% if i.village %}
              <tr>
                <td>Village</td>
                <td>{{ i.village }}</td>
              </tr>
              {% endif %}
    
              {% if i.district %}
              <tr>
                <td>District</td>
                <td>{{ i.district }}</td>
              </tr>
              {% endif %}
    
              {% if i.state %}
              <tr>
                <td>State</td>
                <td>{{ i.state }}</td>
              </tr>
              {% endif %}
    
            </tbody>
          </table>
          </br>`

          var popupOptions =
        {
          'maxWidth': '500',
          'className' : 'another-popup' // classname for another popup
        }
           var markers = L.marker(["{{ i.lat }}", "{{ i.lng }}"], {icon:wellIcon}).bindPopup(table, popupOptions);
           wellslayerGroup.addLayer(markers).addTo(mymap);


        {% endfor %}
    }
    else{

    }
   
      

     
}
// defineWell()
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

                            <script src="https://d3js.org/d3.v4.min.js"></script>


<script>
    var x = 1; //Initial field counter is 1
// $(document).ready(function(){
    var maxField = 10; //Input fields increment limitation
    var addButton = $('.add_button'); //Add button selector
    var wrapper = $('.field_wrapper'); //Input field wrapper
    var dropdown = `<select name="field_name[]" ><option value="Akola">Akola</option><option value="Amrawati">Amrawati</option></select>`;
    

    var fieldHTML = `<div>Select District:
         <select class='form-control' name="field_name[]" >
          <option value="All">All</option>
          <optgroup label="Vidarbh(East)">
              <option value="Akola">Akola</option>
              <option value="Amrawati">Amrawati</option>
              <option value="buldhana">buldhana</option>
              <option value="Yavatmal">Yavatmal</option>
              <option value="Washim">Washim</option>
          </optgroup>
          <optgroup label="Marathwada">
              <option value="Aurangabad">Aurangabad</option>
              <option value="Beed">Beed</option>
              <option value="Jalna">Jalna</option>
              <option value="Osmanabad">Osmanabad</option>
              <option value="Nanded">Nanded</option>
              <option value="Latur">Latur</option>
              <option value="Parbhani">Parbhani</option>
              <option value="Hingoli">Hingoli</option>
          </optgroup>

          <optgroup label="Kokan">
              <option value="Mumbai City">Mumbai City</option>
              <option value="Mumbai Suburban">Mumbai Suburban</option>
              <option value="Thane">Thane</option>
              <option value="Palghar">Palghar</option>
              <option value="Raigad">Raigad</option>
              <option value="Ratnagiri">Ratnagiri</option>
              <option value="Sindhudurg">Sindhudurg</option>
          </optgroup>

        <optgroup label="Vidarbh(West)">
              <option value="Bhandara">Bhandara</option>
              <option value="Gadchiroli">Gadchiroli</option>
              <option value="Chandrapur">Chandrapur</option>
              <option value="Gondia">Gondia</option>
              <option value="Nagpur">Nagpur</option>
              <option value="Wardha">Wardha</option>
          </optgroup>

            <optgroup label="Khandesh">
              <option value="Ahmednagar">Ahmednagar</option>
              <option value="Dhule">Dhule</option>
              <option value="Jalgaon">Jalgaon</option>
              <option value="Nandurbar">Nandurbar</option>
              <option value="Nashik">Nashik</option>
          </optgroup>

        
            <optgroup label="Paschim Maharashtra">
              <option value="Kolhapur">Kolhapur</option>
              <option value="Pune">Pune</option>
              <option value="Sangli">Sangli</option>
              <option value="Satara">Satara</option>
              <option value="Solapur">Solapur</option>
          </optgroup>
        </select> <a href="javascript:void(0);" class="remove_button"><button style="float: right;"><span class="fa fa-minus"></button></a></div>`; //New input field html 

    
    
    //Once add button is clicked
    $(addButton).click(function(){
        //Check maximum number of input fields
            x++;
            $(wrapper).append(fieldHTML); //Add field html
    });
    
    //Once remove button is clicked
    $(wrapper).on('click', '.remove_button', function(e){
        e.preventDefault();
        $(this).parent('div').remove(); //Remove field html
        x--; //Decrement field counter
    });
// });
var myDistrictLayerList = [];



//object
var listOfDistrict = ['All','Akola','Amrawati','Buldhana','Yavatmal','Washim','Aurangabad','Beed','Jalna','Osmanabad','Nanded','Latur','Parbhani','Hingoli','Mumbai City','Mumbai Suburban','Thane','Palghar','Raigad','Ratnagiri','Sindhudurg','Bhandara','Gadchiroli','Chandrapur','Gondia','Nagpur','Wardha','Ahmednagar','Dhule','Jalgaon','Nandurbar','Nashik','Kolhapur','Pune','Sangli','Satara','Solapur'];

var villageLayerCode = ['geonode:villagecensus_maharashtra_1_0','Akola','Amravati','buldhana','Yavatmal','Washim','Aurangabad','Bid','Jalna','Osmanabad','Nanded','Latur','Parbhani','Hingoli','mumbai_city','mumbai_suburban','Thane','Palghar','Raigarh','Ratnagiri','Sindhudurg','Bhandara','Gadchiroli','Chandrapur','Gondia','Nagpur','Wardha','Ahmadnagar','Dhule','Jalgaon','Nandurbar','Nashik','Kolhapur','Pune','Sangli','Satara','Solapur'];

var houseLayerCode = ['geonode:household','Akola','Amravati','buldhana','Yavatmal','Washim','Aurangabad','Bid','Jalna','Osmanabad','Nanded','Latur','Parbhani','Hingoli','mumbai_city','mumbai_suburban','Thane','Palghar','Raigarh','Ratnagiri','Sindhudurg','Bhandara','Gadchiroli','Chandrapur','Gondia','Nagpur','Wardha','Ahmadnagar','Dhule','Jalgaon','Nandurbar','Nashik','Kolhapur','Pune','Sangli','Satara','Solapur'];

var townLayerCode = ['geonode:town','AKOLA','AMRAVATI','buldhana','YAVATMAL','WASHIM','AURANGABAD','BID','JALNA','OSMANABAD','NANDED','LATUR','PARBHANI','HINGOLI *','mumbai_city','mumbai_suburban','THANE','Palghar','RAIGARH','RATNAGIRI','SINDHUDURG','BHANDARA','GADCHIROLI','CHANDRAPUR','GONDIYA','NAGPUR','WARDHA','AHMADNAGAR','DHULE','JALGAON','NANDURBAR','NASHIK','KOLHAPUR','PUNE','SANGLI','SATARA','SOLAPUR'];

var demoLayerCode = ['geonode:maha_demography','akola','amravati','buldhana','yavatmal','washim','aurangabad','beed','jalna','osmanabad','nanded','latur','parbhani','hingoli','mumbai_city','mumbai_suburban','thane','palghar','raigarh','ratnagiri','sindhudurg','bhandara','gadchiroli','chandrapur','gondia','nagpur','wardha','ahmadnagar','dhule','jalgaon','nandurbar','nashik','kolhapur','pune','sangli','satara','solapur'];

var adminLayerCode = ['geonode:maha_rural_plus_urban','akola','amravati','buldhana','yavatmal','washim','aurangabad','beed','jalna','osmanabad','nanded','latur','parbhani','hingoli','mumbai_city','mumbai_suburban','thane','palghar','raigad','ratnagiri','sindhudurg','bhandara','gadchiroli','chandrapur','gondia','nagpur','wardha','ahmednagar','dhule','jalgaon','nandurbar','nashik','kolhapur','pune','sangli','satara','solapur'];
var districtLat = [19.076,20.7002,20.9374,20.4561,20.3888,20.139,19.8762,18.9891,19.8297,18.207,19.1383,18.4088,19.2644,19.5781,19.0176,19.1538,19.2183,19.6936,18.5158,16.9902,16.3492,21.0736,19.4969,19.9615,21.4624,21.1458,20.7453,19.0948,20.9042,21.0077,21.7469,19.9975,16.705,18.5204,16.8524,17.6805,17.6599];
var districtLong = [72.8777,77.0082,77.7796,76.3637,78.1204,77.1025,75.3433,75.7601,75.88,76.1784,77.321,76.5604,76.6413,77.1025,72.8561,72.8752,72.9781,72.7655,73.1822,73.312,73.5594,79.8297,80.2767,79.2961,80.221,79.0882,78.6022,74.748,74.7749,75.5626,74.124,73.7898,74.2433,73.8567,74.5815,74.0183,74.9064];
var districtZoom = [7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8];


var LayerList = [];

const domain = ['https://geoserver2.communitygis.net/','http://localhost/'];

var rootUrl = domain[0] + 'geoserver/geonode/ows';

var base_url =
      domain[0] +
      "geoserver/geonode/ows?service=WFS&version=1.0.0&request=GetFeature&outputformat=application/json&";
    

var attribute_table = L.control({ position: "bottomright" });

var defaultParameters = {
service: 'WFS',
version: '1.0.0',
request: 'GetFeature',
outputFormat: 'application/json'
};

var newLayerList = [];
var wmshealthLayerList = [];
var distLayerList = [];
var pinLayerList = [];
var talLayerList = [];
var list = [];

function clearAllLayers(){
    for (var i = myDistrictLayerList.length - 1; i >= 0; i--) {
        source.getLayer(myDistrictLayerList[i]).addTo(mymap).remove(mymap);;
        
    }

 LayerList.forEach(layer => mymap.removeLayer(layer));


}


function getRandomColor() {
  var letters = '0123456789ABCDEF';
  var color = '#';
  for (var i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

function onEachFeature(feature, layer) {
    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: zoomToFeature
    });

    if (feature.properties) {
        console.log("THIS IS ON EACH FEATURE");
        layer.bindPopup(
          "<table class = 'popupclass' ><tr><td>District Name:</td><td>" +
            feature.properties.distname +
            "</td></tr>" +
            "<tr><td>Taluka Name:</td><td>" +
            feature.properties.taluka_nam +
            "</tr>" +
            "<tr><td>ATC:</td><td>" +
            feature.properties.atc +
            "</td></tr></table>"
        );
      }
}

function zoomToFeature(e) {
    mymap.fitBounds(e.target.getBounds());
}

function highlightFeature(e) {
    clear_distlayer();
    var layer = e.target;

    layer.setStyle({
        weight: 5,
        color: '#FFFF00',
        dashArray: '',
        // fillOpacity: 0.7
        
    });
    info.update(layer.feature.properties);
    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        layer.bringToFront();
    }
}

function resetHighlight(e) {
    geojson.resetStyle(e.target);
    info.update();
}

//  custom control 
var info = L.control({position:"bottomright"});

info.onAdd = function (mymap) {
    this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
    this.update();
    // // this._div.update();
    return this._div;
    
};

function hideTable() {
      mymap.removeControl(attribute_table);
      ctlSidebar.show();
    }

    var legend = L.control({ position: "bottomright" });
    var downloadThisTable;

    $("#block_s").click(function () {
      var taluka_name = document.getElementById("block_s").value;

      attribute_table.onAdd = function (mymap) {
        var div = L.DomUtil.create("div", "myAttributeTable");
        div.innerHTML +=
          "<button style='float: right'class='btn btn-danger' onclick='hideTable()'><i class='fa fa-times-circle' aria-hidden='true'></i></button>";

        layer_url =
          base_url +
          "&typeName=geonode%3Amaha_taluka_13march2021&cql_filter=taluka_nam='" +
          taluka_name +
          "'";
        fetch(layer_url)
          .then(function (response) {
            if (response.status !== 200) {
              console.log(
                "Looks like there was a problem. Status Code: " +
                  response.status
              );
              return;
            }

            response.json().then(function (layer) {
              var propsJSON = create_property_json(layer.features);
              var col = [];
              for (var i = 0; i < propsJSON.length; i++) {
                for (var key in propsJSON[i]) {
                  if (col.indexOf(key) === -1) {
                    col.push(key);
                  }
                }
              }

            });
          })
          .catch(function (err) {
            console.log("Fetch Error :-S", err);
          });
        return div;
      };

    //   attribute_table.addTo(mymap);
      // }
    });

    function create_property_json(feature) {
      var json_props = [];
      feature.forEach((feat) => {
        json_props.push(feat.properties);
      });
      return json_props;
    }



function displayPolygon(param_obj,lat,long){

var parameters = L.Util.extend(param_obj);
layer_url = rootUrl + L.Util.getParamString(parameters)
LayerList.forEach(layer => mymap.removeLayer(layer));
// console.log(layer_url);
mymap.spin(true,{lines: 15, length: 1, width: 50, scale: 200,radius: 200, color: "grey"});
fetch(layer_url)
.then(
    function(response) {
    if (response.status !== 200) {
        console.log('Looks like there was a problem. Status Code: ' +
        response.status);
        return;
    }

    // Examine the text in the response
    response.json().then(function(geojsonData) {
        console.log(geojsonData.features);
        mymap.setView([lat, long], 11);
        geojson = L.geoJson(geojsonData.features, {
        style : style,
        // onEachFeature: onEachFeature
    }).addTo(mymap);
    LayerList.push(geojson);
    console.log(geoJson);
    mymap.spin(false);

    });


    }
)
.catch(function(err) {
    console.log('Fetch Error :-S', err);
});
// }

    
}




$('.select').click(function() {
                                    $(this).toggleClass('highlight')
                                });

                                

$(document).ready(function() {

 $('#indstate').on('change', function() {
    // $("#pv").show();
    // $("#hospital").show();
 });

 $('#district').on('change',function(){
     $("#wells_district").show();
 });
//console.log("hi",indstate);

$('#district').on('change', function() {
                                        //$("#block").show();
                                        // var state=document.getElementById("indstate");
                                        // console.log(state);
                                        if (this.value == 'Mumbai City') {
                                            $("#mumwards").show();
                                            $("#mumsubwards").hide();
                                            removewards();

                                            $("#block").hide();
                                        } else if (this.value == 'Mumbai Suburban') {
                                            $("#mumwards").hide();
                                            removewards();
                                            $("#mumsubwards").show();

                                            $("#block").hide();
                                        } else if (indstate == "Chhattisgarh") {

                                            $("#block").hide();
                                            // $("#pv").show();

                                        } else {
                                            $("#mumwards").hide();
                                            $("#mumsubwards").hide();
                                            // $("#pv").show();
                                            $("#block").show();
                                            

                                        }
                                    });


$('#view_s').on('change', function() { 
     if (this.value == 'Navigated Area View') {
        wmshealthLayerList.forEach(l => {
            mymap.removeLayer(l);
        })


        // $("#indiaview").hide();
        
        $("#navigatedarea").show();
        // $("#pv").show();
        
        clear_layer();
        // clearpoint_layer();
        // removeWFSfac();
        // removeKoboHealthFacity();
        // removeKoboHealthFacitywms(facility);
        clear_distlayer();
        // clear_pinlayer();
    }

});
});


var wms_legend;
function addWMSLegend(layer) {
                                    lagendGraphic = "https://geoserver2.communitygis.net/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=" + layer + "&LEGEND_OPTIONS=forceLabels:on";
                                    wms_legend = L.wmsLegend(lagendGraphic);
                                }
// *****************
let listState = {
                                    'Uttarakhand': ['Uttarakhand', 30.0668, 79.0193],
                                    'Ladakh': ['Ladakh', 34.152588, 77.577049],
                                    'Daman & Diu': ['Daman & Diu', 20.4283, 72.8397],
                                    'Telangana': ['Telangana', 18.1124, 79.0193],
                                    'Odisha': ['Odisha', 20.9517, 85.0985],
                                    'Gujarat': ['Gujarat', 22.2587, 71.1924],
                                    'Andaman & Nicobar Island': ['Andaman & Nicobar Island', 11.7401, 92.6586],
                                    'Maharashtra': ['Maharashtra', 19.7515, 75.7139],
                                    'Andhra Pradesh': ['Andhra Pradesh', 15.91, 79.7439],
                                    'Arunachal Pradesh': ['Arunachal Pradesh', 27.10039878, 93.61660071],
                                    'Assam': ['Assam', 26.7499809, 94.21666744],
                                    'Bihar': ['Bihar', 25.78541445, 87.4799727],
                                    'Chandigarh': ['Chandigarh', 30.71999697, 76.78000565],
                                    'Chhattisgarh': ['Chhattisgarh', 22.09042035, 82.15998734],
                                    'Dadra & Nagar Havelli': ['Dadra & Nagar Havelli', 20.26657819, 73.0166178],
                                    'Delhi': ['Delhi', 28.6699929, 77.23000403],
                                    'Goa': ['Goa', 15.491997, 73.81800065],
                                    'Haryana': ['Haryana', 28.45000633, 77.01999101],
                                    'Himachal Pradesh': ['Himachal Pradesh', 31.10002545, 77.16659704],
                                    'Jammu & Kashmir': ['Jammu & Kashmir', 34.29995933, 74.46665849],
                                    'Jharkhand': ['Jharkhand', 23.80039349, 86.41998572],
                                    'Karnataka': ['Karnataka', 12.57038129, 76.91999711],
                                    'Kerala': ['Kerala', 8.900372741, 76.56999263],
                                    'Lakshadweep': ['Lakshadweep', 10.56257331, 72.63686717],
                                    'Madhya Pradesh': ['Madhya Pradesh', 21.30039105, 76.13001949],
                                    'Manipur': ['Manipur', 24.6637, 93.9063],
                                    'Meghalaya': ['Meghalaya', 25.57049217, 91.8800142],
                                    'Mizoram': ['Mizoram', 23.71039899, 92.72001461],
                                    'Nagaland': ['Nagaland', 25.6669979, 94.11657019],
                                    'Orissa': ['Orissa', 19.82042971, 85.90001746],
                                    'Puducherry': ['Puducherry', 11.93499371, 79.83000037],
                                    'Punjab': ['Punjab', 31.51997398, 75.98000281],
                                    'Rajasthan': ['Rajasthan', 26.44999921, 74.63998124],
                                    'Sikkim': ['Sikkim', 27.3333303, 88.6166475],
                                    'Tamil Nadu': ['Tamil Nadu', 12.92038576, 79.15004187],
                                    'Tripura': ['Tripura', 23.83540428, 91.27999914],
                                    'Uttar Pradesh': ['Uttar Pradesh', 27.59998069, 78.05000565],
                                    ',Uttaranchal': ['Uttaranchal', 30.32040895, 78.05000565],
                                    'West Bengal': ['West Bengal', 22.58039044, 88.32994665]
                                }

                                let listDistrict = {
                                    'Akola': ['Akola', 20.7002, 77.0082],
                                    'Amravati': ['Amravati', 20.9374, 77.7796],
                                    'buldhana': ['buldhana', 20.4561, 76.3637],
                                    'Yavatmal': ['Yavatmal', 20.3888, 78.1204],
                                    'Washim': ['Washim', 20.139, 77.1025],
                                    'Aurangabad': ['Aurangabad', 19.8762, 75.3433],
                                    'Beed': ['Beed', 18.9891, 75.7601],
                                    'Jalna': ['Jalna', 19.8297, 75.88],
                                    'Osmanabad': ['Osmanabad', 18.207, 76.1784],
                                    'Nanded': ['Nanded', 19.1383, 77.321],
                                    'Latur': ['Latur', 18.4088, 76.5604],
                                    'Parbhani': ['Parbhani', 19.2644, 76.6413],
                                    'Hingoli': ['Hingoli', 19.5781, 77.1025],
                                    'Thane': ['Thane', 19.2183, 72.9781],
                                    'Palghar': ['Palghar', 19.6936, 72.7655],
                                    'Raigad': ['Raigad', 18.5158, 73.1822],
                                    'Ratnagiri': ['Ratnagiri', 16.9902, 73.312],
                                    'Sindhudurg': ['Sindhudurg', 16.3492, 73.5594],
                                    'Bhandara': ['Bhandara', 21.0736, 79.8297],
                                    'Mumbai City': ['Mumbai City', 18.942, 72.816],
                                    'Mumbai Suburban': ['Mumbai Suburban', 19.118, 72.905],
                                    'Gadchiroli': ['Gadchiroli', 19.4969, 80.2767],
                                    'Chandrapur': ['Chandrapur', 19.9615, 79.2961],
                                    'Gondia': ['Gondia', 21.4624, 80.221],
                                    'Nagpur': ['Nagpur', 21.1458, 79.0882],
                                    'Wardha': ['Wardha', 20.7453, 78.6022],
                                    'Ahmadnagar': ['Ahmadnagar', 19.0948, 74.748],
                                    'Dhule': ['Dhule', 20.9042, 74.7749],
                                    'Jalgaon': ['Jalgaon', 21.0077, 75.5626],
                                    'Nandurbar': ['Nandurbar', 21.7469, 74.124],
                                    'Nashik': ['Nashik', 19.9975, 73.7898],
                                    'Kolhapur': ['Kolhapur', 16.705, 74.2433],
                                    'Pune': ['Pune', 18.5204, 73.8567],
                                    'Sangli': ['Sangli', 16.8524, 74.5815],
                                    'Satara': ['Satara', 17.6805, 74.0183],
                                    'Solapur': ['Solapur', 17.6599, 74.9064]
                                }
                                let area = null;

                                $('#indstate').on('change', function() {

                                    if (area) {
                                        mymap.removeLayer(area);
                                    }
                                    clear_layer();
                                    // clearpoint_layer();
                                    // clear_pinlayer();
                                    let indstate = document.getElementById('indstate').value;

                                    putWMSLayerst();


                                    //mymap.spin(true,{lines: 15, length: 1, width: 50, scale: 200,radius: 200, color: "grey"});
                                    })

                                    $('#district').on('change', function() {
                                    if (area) {
                                        mymap.removeLayer(area);
                                    }
                                    //clear_layer();
                                    
                                    // clearpoint_layer();
                                    // clear_pinlayer();
                                    let district = document.getElementById('district').value;

                                    putWMSLayerdist();


                                    //mymap.spin(true,{lines: 15, length: 1, width: 50, scale: 200,radius: 200, color: "grey"});
                                    })

                                    $('#block_s').on('change', function() {

                                        // clearpoint_layer();
                                        if (area) {
                                            mymap.removeLayer(area);
                                        }
                                        clear_tallayer();
                                        let taluka = document.getElementById('block_s').value;

                                        putWMSLayertaluka();


                                        //mymap.spin(true,{lines: 15, length: 1, width: 50, scale: 200,radius: 200, color: "grey"});
                                    })

                                    $('#pincode').on('change',function(){
                                        if (area) {
                                            mymap.removeLayer(area);
                                        }
                                        clear_pinlayer();
                                        let pincode = document.getElementById('pincode').value;
                                        putWMSLayerpincode();
                                    })                                    

                                    
                                //this is for putting districts in drop down menu
                                function putWMSLayer() {
                                    var aspiD = document.getElementById('district').value;
                                    var distLayerLatLong = listDistrict[aspiD];
                                    //clear_layer();
                                    //console.log('kk',distLayerLatLong);
                                    var wms_layer = L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/wms', {
                                        layers: 'geonode:maha_taluka_13March2021',
                                        format: 'image/png',
                                        transparent: 'true',
                                        tiled: true,

                                        //opacity:0.5,
                                        // version: '1.3.0',
                                        cql_filter: "distname='" + distLayerLatLong[0] + "'",
                                        style: ""
                                    });
                                    clear_layer();
                                    clearpoint_layer();
                                    wms_layer.addTo(mymap);
                                    mymap.setView([distLayerLatLong[1], distLayerLatLong[2]], 9);

                                    //console.log(wms_layer);
                                    LayerList.push(wms_layer);
                                    // addWMSLegend(layer);


                                }

                                    function putWMSLayerst() {
                                    clear_distlayer();
                                    clear_tallayer();
                                    clear_pinlayer();    
                                    indstate = document.getElementById('indstate').value;
                                    //console.log(indstate);
                                    var stLayerLatLong = listState[indstate];

                                    var wms_layer = L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/wms', {
                                        layers: 'geonode:states_in_india',
                                        format: 'image/png',
                                        transparent: 'true',
                                        // version: '1.3.0',
                                        cql_filter: "state='" + stLayerLatLong[0] + "'",
                                        style: ""
                                    });
                                    clear_layer();
                                    
                                    clear_distlayer();
                                    // clearpoint_layer();
                                    wms_layer.addTo(mymap);
                                    mymap.setView([stLayerLatLong[1], stLayerLatLong[2] - 2], 7);
                                    LayerList.push(wms_layer);
                                    // addWMSLegend(layer);
                                    console.log(LayerList);
                                    

                                }


                                function putWMSLayerdist() {
                                    // clear_layer();
                                    clear_distlayer();
                                    clear_tallayer();
                                    clear_pinlayer();
                                    var dist = document.getElementById('district').value;
                                    var state = document.getElementById('indstate').value;
                                    // var layers = 'geonode:india_pincodes_12june';
                                    console.log(dist,state)
                                    var layers = 'geonode:all_india_districts_11june2020';
                                    //console.log(indstate);
                                    // var distLayerLatLong= listDistrict[dist];
                                    if (dist == 'Mumbai City' || dist == 'Mumbai Suburban')
                                        mymap.setView([19.0760, 72.8777], 11);
                                    if (state == "Chhattisgarh") {
                                        layers = 'geonode:all_india_districts_11june2020';
                                    }
                                    var wms_layer = L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/wms', {
                                        layers: layers,
                                        format: 'image/png',
                                        transparent: 'true',
                                        // version: '1.3.0',
                                        cql_filter: `district='${dist}' AND state='${state}'`,
                                        // cql_filter: "district='" + distLayerLatLong[0] + "'",
                                        style: ""
                                    });
                                    // clear_layer(); 
                                    // clear_distlayer();   
                                    clear_tallayer();
                                    
                                    
                                    clear_pinlayer();
                                    
                                    //console.log(wms_layer);
                                    //clear_layer();
                                    //clearpoint_layer();
                                    wms_layer.addTo(mymap);
                                    // mymap.setView([distLayerLatLong[1],distLayerLatLong[2]],8);
                                    // mymap.setView(layers,dist);
                                    // setView1('geonode:india_pincodes_12june',dist);
                                    setView1('geonode:all_india_districts_11june2020',dist);
                                    distLayerList.push(wms_layer);
                                    // addWMSLegend(layer);
                                    console.log(distLayerList);

                                }
                                
                                var districtLayer;
                                function putdist() {
                                    // clear_layer();
                                    // clear_distlayer();
                                    // clear_tallayer();
                                    // clear_pinlayer();
                                    var dist = "Nashik";
                                    var state = "Maharashtra";
                                    // var layers = 'geonode:india_pincodes_12june';
                                    console.log(dist,state)
                                    var layers = 'geonode:all_india_districts_11june2020';
                                    //console.log(indstate);
                                    // var distLayerLatLong= listDistrict[dist];
                                    if (dist == 'Mumbai City' || dist == 'Mumbai Suburban')
                                        mymap.setView([19.0760, 72.8777], 11);
                                    if (state == "Chhattisgarh") {
                                        layers = 'geonode:all_india_districts_11june2020';
                                    }
                                    var districtLayer = L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/wms', {
                                        layers: layers,
                                        format: 'image/png',
                                        transparent: 'true',
                                        // version: '1.3.0',
                                        cql_filter: `district='${dist}' AND state='${state}'`,
                                        // cql_filter: "district='" + distLayerLatLong[0] + "'",
                                        style: ""
                                    });
                                    console.log(districtLayer)
                                    // clear_layer(); 
                                    // clear_distlayer();   
                                    // clear_tallayer();
                                    
                                    
                                    // clear_pinlayer();
                                  
                                    //console.log(wms_layer);
                                    //clear_layer();
                                    //clearpoint_layer();
                                    districtLayer.addTo(mymap);
                                    // mymap.setView([distLayerLatLong[1],distLayerLatLong[2]],8);
                                    // mymap.setView(layers,dist);
                                    // setView1('geonode:india_pincodes_12june',dist);
                                    setView1('geonode:all_india_districts_11june2020',dist);
                                    distLayerList.push(districtLayer);
                                    // addWMSLegend(layer);
                                    console.log(distLayerList);

                                }
                                function removeDistrictLayer() {
                                    mymap.removeLayer(districtLayer);
                                }
                                function putWMSLayertaluka() {
                                    clear_pinlayer();
                                    
                                    var dist = document.getElementById('district').value;
                                    var taluka = document.getElementById('block_s').value;

                                    var wms_layer = L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/wms', {
                                        layers: "geonode:maha_taluka_13march2021",
                                        // cql_filter: "taluka_nam='" + taluka + "'",
                                        cql_filter: `taluka_nam='${taluka}' AND distname='${dist}'`,
                                        format: 'image/png',
                                        transparent: 'true',
                                        // style: "color:red",
                                    });
                                    // clear_layer();                                    
                                    
                                    // clear_tallayer();
                                    // clear_pinlayer();
                                    // console.log(wms_layer);
                                    wms_layer.addTo(mymap);
                                    setView('geonode:maha_taluka_13march2021', taluka);

                                    talLayerList.push(wms_layer);
                                    // console.log(taluka);    
                                    console.log(talLayerList);

                                }

                                function putWMSLayerpincode() {
                                    // clear_tallayer();
                                    // clear_pinlayer();
                                    var state = document.getElementById('indstate').value;
                                    var district = document.getElementById('district').value;
                                    var taluka = document.getElementById('block_s');
                                    var pincode = document.getElementById('pincode').value;

                                    var wms_layer = L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/wms', {
                                        layers: "geonode:india_pincodes_12june",
                                        cql_filter: "pincode='" + pincode + "'",
                                        cql_filter: `pincode='${pincode}' AND district='${district}'`,
                                        format: 'image/png',
                                        transparent: 'true',
                                        highlightFeature: 'true',
                                        
                                    });
                                    // clear_layer();
                                    // clear_tallayer();
                                    // clear_distlayer();
                                    // clear_pinlayer();
                                    wms_layer.addTo(mymap);
                                    // setView('geonode:india_pincodes_12june', pincode);

                                    pinLayerList.push(wms_layer);


                                }

                                function getBoundary(obj) {
                                    let boundary = obj.value;
                                    if ($(obj).is(":checked")) {
                                        
                                        if (boundary == "{state}")
                                            putWMS("geonode:states_in_india");
                                        else if (boundary == "{district}")
                                            putWMS("geonode:all_india_districts_11june2020");
                                        else if (boundary == "{mumwards}")
                                            putwards("Mumbai City", 'geonode:corporatorwardboundary_mumbai_13may');
                                        else if (boundary == "{mumadm}")
                                            putwards("Mumbai City", 'geonode:mumbai_ward_boundary');
                                        else if (boundary == "{mumsubwards}")
                                            putwards("Mumbai Suburban", 'geonode:corporatorwardboundary_mumbai_13may');
                                        else if (boundary == "{mumadmsubwards}")
                                            putwards("Mumbai Suburban", 'geonode:mumbai_ward_boundary');
                                        else if (boundary == "{Nashik_wells}")
                                            putlayers("geonode:Nashik_district_well");
                                        else
                                            putWMS("geonode:maha_demography_with_mumbai");
                                    } else {
                                        if (boundary == "{state}")
                                            removeWMS("geonode:states_in_india");
                                        else if (boundary == "{district}")
                                            removeWMS("geonode:all_india_districts_11june2020");
                                        else if (boundary == "{mumwards}")
                                            removewards();
                                        else if (boundary == "{mumsubwards}")
                                            removewards();
                                        else if (boundary == "{mumadmsubwards}")
                                            removewards();
                                        else if (boundary == "{mumadm}")
                                            removewards();
                                        else if (boundary == "{Nashik_wells}"){
                                            // removeWFSfac("CHC");
                                            removeWMS("geonode:Nashik_district_well");
                                            location.reload();
                                        }
                                        else
                                            removeWMS("geonode:maha_demography_with_mumbai");
                                    }
                                }
                                function removeWMS(unchecked_layer) {
                                    if (wms_legend) {
                                        mymap.removeControl(wms_legend);
                                    }
                                    newLayerList.forEach((layer, index) => {
                                        if (layer.options.layers === unchecked_layer) {
                                            mymap.removeLayer(layer);
                                            newLayerList.splice(index, 1);
                                        }
                                    });
                                }

                                // let area = null;
                                //this setView is for taluka
                                function setView(layerName, selectedBoundary) {
                                    // alert(layerName);
                                    var district = document.getElementById('district').value;
                                    if (area) {
                                        mymap.removeLayer(area);
                                    }
                                    // let rootUrl = '{{site_url}}geoserver/geonode/ows';
                                    let rootUrl = 'https://geoserver2.communitygis.net/geoserver/geonode/ows';
                                    let options = {
                                        service: 'WFS',
                                        version: '1.0.0',
                                        request: 'GetFeature',
                                        outputFormat: 'application/json',
                                        typeName: layerName,
                                        cql_filter: `taluka_nam='${selectedBoundary}'`,
                                        // cql_filter: `taluka_nam='${selectedBoundary}' AND distname='${district}'`,
                                        propertyName: 'the_geom,distname,taluka_nam,atc',
                                    };
                                    let parameters = L.Util.extend(options);
                                    layer_url = rootUrl + L.Util.getParamString(parameters)
                                
                                    // console.log(layer_url);
                                    fetch(layer_url).then(
                                        function(response) {
                                            if (response.status !== 200) {
                                                console.log('Looks like there was a problem. Status Code: ' +
                                                    response.status);
                                                return;
                                            }
                                            response.json().then(function(geojsonData) {
                                                area = L.geoJson(geojsonData.features).addTo(mymap)
                                                lat = area.getBounds()._northEast.lat
                                                lng = area.getBounds()._northEast.lng
                                                mymap.setView([lat, lng - 0.4], 10);
                                                geojson = L.geoJson(geojsonData.features, {
                                                // style : style1,
                                                onEachFeature: onEachFeature
                                                }).addTo(mymap);
                                                // LayerList.push(geojson);
                                                talLayerList.push(geojson);
                                                mymap.spin(false);
                                            });
                                        }).catch(function(err) {
                                        console.log('Fetch Error :-S', err);
                                        
                                    });
                                    // console.log(layer_url);
                                    
                                }


                                let activatedHealthFacility = {}

        function putWFSFacility(facility,district) {
            putdist()
            var wellIcon = L.icon({
                    iconUrl: "{% static 'map/images/well.png' %}",
                    iconSize:     [30, 40], // size of the icon
                    //shadowSize:   [50, 64], // size of the shadow
                    iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
                    // shadowAnchor: [4, 62],  // the same for the shadow
                    popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
                });
                                var geojsonMarkerOptions = {
                                    radius: 6,
                                    fillColor: "#013378",
                                    color: "#000",
                                    weight: 1,
                                    opacity: 1,
                                    fillOpacity: 0.8
                                };

                                var geojsonMarkerOptions2 = {
                                    radius: 6,
                                    fillColor: "#0004ff",
                                    color: "#000",
                                    weight: 1,
                                    opacity: 1,
                                    fillOpacity: 0.8
                                };

                                var geojsonMarkerOptions3 = {
                                    radius: 5,
                                    fillColor: "#a8325a",
                                    color: "#000",
                                    weight: 1,
                                    opacity: 1,
                                    fillOpacity: 0.8
                                };

                                var geojsonMarkerOptions4 = {
                                    radius: 5,
                                    fillColor: "#143d5e",
                                    color: "#000",
                                    weight: 1,
                                    opacity: 1,
                                    fillOpacity: 0.8
                                };


                                
                                // const url = 'https://geoserver2.communitygis.net/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&outputFormat=json&typename=geonode:maha_village_health_centroid_29mar';
                                const url='https://geonode.communitygis.in/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typename=geonode%3ANashik_district_well&outputFormat=json&srs=EPSG%3A4326&srsName=EPSG%3A4326'
                                const url2 = 'https://geoserver2.communitygis.net/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&outputFormat=json&typename=geonode:townhealth_centroid_15apr';
                               
                                if (facility == 'CHC')
                                {
                                    newurl = url ;
                                    // + `&cql_filter=chc_num>0 AND district_n='${district}'`;
                                }

                                function onEachFeatureForPoint(feature, layer) {
                                    if (facility === 'CHC') {
                                        layer.bindPopup(`<div class = 'text-center'>Well Data<br>
                                District: ${feature.properties.District}<br>
                                Well_Type :${feature.properties.Well_Type}<br>
                                
                                </div>`)
                                    }
                                    if (facility === 'PHC') {
                                        layer.bindPopup(`<div class = 'text-center'>PHC<br>
                                Source: Census 2011<br>
                                Village Name: ${feature.properties.village_na}<br>
                                Distance Range: ${feature.properties.phc_distan}<br>
                                Doctors In Position :${feature.properties.phc_doc_in}<br>
                                Doctors Total Strength :${feature.properties.phc_doc_nu}<br>
                                Para Medical Staff Total Strength : ${feature.properties.phc_param_}<br>
                                Para Medical Staff In Position : ${feature.properties.phc_para_1}fen
                                </div>`)
                                    }
                                    if (facility === 'Allo') {
                                        layer.bindPopup(`<div class = 'text-center'>Allopathy Hospital<br>
                                Distance Range: ${feature.properties.h_allo_dst}<br>
                                Doctors In Position :${feature.properties.h_allo_din}<br>
                                Doctors Total Strength :${feature.properties.h_allo_doc}<br>
                                Total Beds :${feature.properties.h_allo_bed}<br>
                                Para Medical Staff Total Strength : ${feature.properties.h_allo_pm}<br>
                                Para Medical Staff In Position : ${feature.properties.h_allo_pin}
                                </div>`)
                                    } else if (facility === 'Alt') {
                                        layer.bindPopup(`<div class = 'text-center'>Alternate Hospital<br>
                                Distance Range: ${feature.properties.h_alt_dst}<br>
                                Doctors In Position :${feature.properties.h_alt_din}<br>
                                Doctors Total Strength :${feature.properties.h_alt_doc}<br>
                                Total Beds :${feature.properties.h_alt_bed}<br>
                                Para Medical Staff Total Strength : ${feature.properties.h_alt_pm}<br>
                                Para Medical Staff In Position : ${feature.properties.h_alt_pin}
                                </div>`)
                                    }

                                }
                                fetch(newurl).then(
                                    function(response) {
                                        if (response.status !== 200) {
                                            console.log('Looks like there was a problem. Status Code: ' +
                                                response.status);
                                            return;
                                        }
                                        
                                        response.json().then(function(geojsonData) {
                                            // console.log(geojsonData.features);
                                            healthFacility = L.geoJson(geojsonData.features, {
                                                pointToLayer: function(feature, latlng) {
                                                    if (facility === 'CHC')
                                                        return L.circleMarker(latlng, geojsonMarkerOptions);
                                                    else if (facility === 'PHC')
                                                        return L.circleMarker(latlng, geojsonMarkerOptions2);
                                                    else if (facility === 'Allo')
                                                        return L.circleMarker(latlng, geojsonMarkerOptions3);
                                                    else if (facility === 'Alt')
                                                        return L.circleMarker(latlng, geojsonMarkerOptions4);
                                                },
                                                onEachFeature: onEachFeatureForPoint,
                                            }).addTo(mymap);
                                            var hel=healthFacility1
                                            //legend.addTo(mymap);
                                          
                                            activatedHealthFacility[facility] = healthFacility;
                                            
                                            
                                            //legend.update();
                                        });
                                        

                                    }).catch(function(err) {
                                    console.log('Fetch Error :-S', err);
                                });
                                //})
                                };

                                // putWFSFacility("CHC","Nashik");

                                function removeWFSfac(facility) {
                                    console.log(activatedHealthFacility)
                                    mymap.removeLayer(activatedHealthFacility[facility]);
                                    // remove(facility);
                                    // legend.update();
                                    location.reload();
                                };



                                function GetSelectedfac(obj) {
                                   
                                    let fac = obj.value;
                                    var district = document.getElementById('district').value;
                                    if ($(obj).is(":checked")) {
                                        if (fac == "{CHC}")
                                        {
                                        putWFSFacility("CHC","Nashik");
                                        }
                                    } else {
                                        mymap.removeLayer(circle);
                                        oldhfbb.forEach(layer => mymap.removeLayer(layer));
                                        healthFacilityInBB = null;
                                        healthFacility2 = null;
                                        healthFacility1 = null;
                                        if (fac === "{CHC}")
                                            removeWFSfac("CHC");
                                        else if (fac === "{PHC}")
                                            removeWFSfac("PHC");
                                        else if (fac == '{Allo}')
                                            removeWFSfac("Allo");

                                        else if (fac == '{Alt}')
                                            removeWFSfac("Alt");
                                        else if (fac == '{DCH}')
                                            removeArogya("DCH");
                                        else if (fac == '{DCHC}')
                                            removeArogya("DCHC");
                                        else if (fac == '{DCCC}')
                                            removeArogya("DCCC");
                                    };
}




                                function setView1(layerName, selectedBoundary) {
                                    // alert(layerName);
                                    if (area) {
                                        mymap.removeLayer(area);
                                    }
                                    // let rootUrl = '{{site_url}}geoserver/geonode/ows';
                                    let rootUrl = 'https://geoserver2.communitygis.net/geoserver/geonode/ows';
                                    let options = {
                                        service: 'WFS',
                                        version: '1.0.0',
                                        request: 'GetFeature',
                                        outputFormat: 'application/json',
                                        typeName: layerName,
                                        cql_filter: `district='${selectedBoundary}'`,
                                        // propertyName: 'the_geom,distname,taluka_nam,atc',
                                    };
                                    let parameters = L.Util.extend(options);
                                    layer_url = rootUrl + L.Util.getParamString(parameters)
                                
                                    // console.log(layer_url);
                                    fetch(layer_url).then(
                                        function(response) {
                                            if (response.status !== 200) {
                                                console.log('Looks like there was a problem. Status Code: ' +
                                                    response.status);
                                                return;
                                            }
                                            response.json().then(function(geojsonData) {
                                                area = L.geoJson(geojsonData.features).addTo(mymap)
                                                lat = area.getBounds()._northEast.lat
                                                lng = area.getBounds()._northEast.lng
                                                mymap.setView([lat, lng - 0.4], 8);
                                                geojson = L.geoJson(geojsonData.features, {
                                                // style : style1,
                                                onEachFeature: onEachFeature
                                                }).addTo(mymap);
                                                // LayerList.push(geojson);
                                                distLayerList.push(geojson);
                                                
                                                mymap.spin(false);
                                            });
                                        }).catch(function(err) {
                                        console.log('Fetch Error :-S', err);
                                        
                                    });
                                    // console.log(layer_url);
                                    
                                }

                           


                                //this function is for state boundary
                                function putWMS(layer) {
                                    var wms_layer = L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/wms', {
                                        layers: layer,
                                        format: 'image/png',
                                        transparent: 'true',
                                    });
                                    wms_layer.addTo(mymap);
                                    newLayerList.push(wms_layer);

                                    if (wms_legend) {
                                        mymap.removeControl(wms_legend);
                                    }
                                    //console.log(wms_legend); 
                                    addWMSLegend(layer);
                                    TRIBLAYER = "https://geoserver2.communitygis.net/geoserver/geonode/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&LAYERS=" + wms_layer.options.layers + "&QUERY_LAYERS=" + wms_layer.options.layers;


                                }
                                function putlayers(layer) {
                                    putdist() 
                                    // var wms_layer = L.tileLayer.wms('https://geonode.communitygis.in/geoserver/ows?service=WMS', {
                                    //     layers: layer,
                                    //     format: 'image/png',
                                    //     transparent: 'true',
                                    //     tiled: "true",
                                    //     opacity: 0.7,
                                    // });
                                    // wms_layer.addTo(mymap);
                                    // newLayerList.push(wms_layer);

                                    // if (wms_legend) {
                                    //     mymap.removeControl(wms_legend);
                                    // }
                                    // //console.log(wms_legend); 
                                    // addWMSLegend(layer);
                                    // TRIBLAYER = "https://geoserver2.communitygis.net/geoserver/geonode/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&LAYERS=" + wms_layer.options.layers + "&QUERY_LAYERS=" + wms_layer.options.layers;


                                }
                                    
                                function clear_layer() {
                                    LayerList.forEach(layer => mymap.removeLayer(layer));

                                }

                                function clear_distlayer() {
                                    distLayerList.forEach(layer => mymap.removeLayer(layer));

                                }

                                function clear_tallayer() {
                                    talLayerList.forEach(layer => mymap.removeLayer(layer));

                                }


                                function clear_pinlayer() {
                                    pinLayerList.forEach(layer => mymap.removeLayer(layer));

                                }

                                function copyToClipboard(text) {
    var dummy = document.createElement("textarea");
    // dummy.style.display = 'none'
    document.body.appendChild(dummy);
    dummy.value = text;
    dummy.select();
    document.execCommand("copy");
    document.body.removeChild(dummy);
}

var pvIcon = L.icon({
            iconUrl: "{% static 'map/images/well.png' %}",
            iconSize:     [40, 40], // size of the icon
            //shadowSize:   [50, 64], // size of the shadow
            iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
            // shadowAnchor: [4, 62],  // the same for the shadow
            popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
        });
const url1 = 'https://gist.githubusercontent.com/AnimeshN/bf517d5fd3cf387a73e49404037f1c4d/raw/15ae046fc379c62f63934b86b9dda97d8165d4d6/organization_wise_compendium.json'
const url2 = 'https://gist.githubusercontent.com/RenukaNaik/9d72e300eba069ccc637219290f7f398/raw/124d761d55d1686ffb753a7c51bf5763a0aa8305/poshan.json'
function getPoshan(clickedCheckBox){
    let value = clickedCheckBox.value;
    var state = document.getElementById('indstate').value;
    console.log(state);
    console.log(value);
    var compendium
    if ($(clickedCheckBox).is(':checked')) {
        console.log("show vatika");
        fetch(url2).then(res => {
        res.json().then(
            
            function(geojsonData) {
                compendium = L.geoJson(geojsonData.features, {
                pointToLayer: function(feature, latlng) {
                    if (feature.properties.State ===state ){
                        return L.marker(latlng, {icon:pvIcon});
                    }
                        // return L.marker(latlng, {icon:pvIcon});
                },
                onEachFeature: onEachFeatureForPoint1,
            }).addTo(mymap);
            list.push(compendium);
            console.log(list);
        })
    });

    } else {
                console.log("not");
                // list =[];
                mymap.removeLayer(compendium);
                console.log(list);
            }
}

function removeposhan(){
    $(chkposhan).prop( "checked", false );
    getPoshan($(chkposhan));
}
const onEachFeatureForPoint1 = (feature, layer) =>{
        let img_name = feature.properties.img1.split(".")[0] + ".jpg";
        var str3 = " <img class = 'popupimage1' src='/static/map/cmp_images/".concat(img_name);
        var str4 = str3.concat("' alt='image not found'></br>");
        if(feature.properties.img2!=''){
        // let img_name1 = feature.properties.img2.split(".")[0] + ".jpg";

        var str5 = " <img class = 'popupimage2' src='/static/map/cmp_images/".concat(feature.properties.img2);
        var str6 = str5.concat("' alt='image not found'></br>");}
        else{str6=""}
        if(feature.properties.img3!=''){
        // let img_name2 = feature.properties.img3.split(".")[0] + ".jpg";

        var str7 = " <img class = 'popupimage3' src='/static/map/cmp_images/".concat(feature.properties.img3);
        var str8 = str5.concat("' alt='image not found'> </br>");}
        else{str8=""}

                        // layer.bindPopup(str2);

        const table1 = `
        
        </br></br><table class='striped centered' style="background-color:beige;">
        <thead>
          <tr>
              <th>Place</th>
              <th>${feature.properties.Name}</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td>Organization Name</td>
            <td>${feature.properties.Organisati}</td>
          </tr>

        </tbody>
      </table> </br>
      `
    
        layer.on("click",e => {
          if(str6 ==''&& str8 ==''){
            document.getElementById("content1").innerHTML = table1 + str4;}
            else if(str8==''){
            document.getElementById("content1").innerHTML = table1 + str4 + str6 ;}
            else{
              document.getElementById("content1").innerHTML = table1 + str4 + str6 + str8;}
            var elem1 = document.getElementById('demo-modal1');
            console.log(elem1);
            var instance1 = M.Modal.getInstance(elem1);
            console.log(instance1);
            instance1.open();

        })
    }




  //code for dependent dropdown start    
  function filterCSV(csv, key, value) 
                                {
                                    var result = [];
                                    var unique = [];

                                    csv.forEach(function(val, idx, arr) {

                                        if (val[key] == value) {
                                            //console.log(val.pincode);
                                            if (!unique[val.Districtname]) {
                                                result.push(val.Districtname)
                                                unique[val.Districtname] = 1;
                                            }
                                        }
                                    })
                                    return result;
                                }


                                function filterCSV2(csv, key, value) {
                                    var result = [];
                                    var unique = [];

                                    csv.forEach(function(val, idx, arr) {

                                        if (val[key] == value) {
                                            if (!unique[val.pincode]) {
                                                result.push(val.pincode)
                                                unique[val.pincode] = 1;
                                            }
                                        }
                                    })
                                    return result;
                                }

                                function filterCSV4(csv, key1, value1, key2, value2) {

                                    var result = [];
                                    var unique = [];
                                    csv.forEach(function(val, idx, arr) {

                                            if (val[key1] == value1 && val[key2] == value2) {


                                                result.push(val.pincode);
                                                unique[val.pincode] = 1;


                                            }
                                        })
                                        //console.log(result);
                                    return result;
                                }

                                function filterCSV3(csv, key, value) {
                                    var result = [];
                                    var unique = [];

                                    csv.forEach(function(val, idx, arr) {

                                        if (val[key] == value) {

                                            if (!unique[val.block]) {
                                                //console.log(val.block);

                                                result.push(val.block)
                                                unique[val.block] = 1;
                                            }
                                        }
                                    })
                                    return result;
                                }





                                d3.csv("{% static 'static1/data/healthdash/st_dist_pin.csv' %}", function(data) {
                                    $('#indstate').on("change", function(d) {
                                        var val = d3.select(this).property("value");
                                        $('#district').find('option').not(':first').remove();
                                        var data_1 = filterCSV(data, 'statename', val);
                                        console.log(data_1);
                                        var select = document.getElementById("district");
                                        for (var i = 0; i < data_1.length; i++) {
                                            var opt = data_1[i];
                                            var el = document.createElement("option");
                                            el.textContent = opt;
                                            el.value = opt;
                                            select.appendChild(el);
                                            // console.log(el)
                                            
                                        }
                                        $('#districtd3').val("");
                                        $('#block_s').val("");
                                        $('#pincode').val("");
                                        
                                    });

                                    $('#district').on("change", function(d) {
                                        var val1 = document.getElementById("indstate").value;
                                        console.log(val1);
                                        var val2 = d3.select(this).property("value");
                                        $('#pincode').find('option').not(':first').remove();

                                        // var data_2 = filterCSV4(data, 'statename', val1, 'Districtname', val2);
                                        // console.log(data_2);
                                        // var select = document.getElementById("pincode");
                                        // for (var i = 0; i < data_2.length; i++) {
                                        //     var opt = data_2[i];
                                        //     var el = document.createElement("option");
                                        //     el.textContent = opt;
                                        //     el.value = opt;
                                        //     select.appendChild(el);
                                        //     // console.log(el)
                                        // }
                                        // $('#pincoded3').val("");


                                        $('#block_s').find('option').not(':first').remove();
                                        var data_3 = filterCSV3(data, 'Districtname', val2);
                                        console.log(data_3);
                                        var select = document.getElementById("block_s");
                                        for (var i = 0; i < data_3.length; i++) {
                                            var opt = data_3[i];
                                            var el = document.createElement("option");
                                            el.textContent = opt;
                                            el.value = opt;
                                            select.appendChild(el);
                                            console.log(el)
                                        }
                                        $('#block_sd3').val("");


                                    });

                                    $('#block_s').on("change", function(d){
                                        // clear_layer();
                                        var val3 = document.getElementById("indstate").value;
                                        //console.log(val1);
                                        var val4 = d3.select(this).property("value");
                                        $('#pincode').find('option').not(':first').remove();

                                        var data_4 = filterCSV4(data, 'statename', val3, 'block', val4);
                                        var select = document.getElementById("pincode");
                                        for (var i = 0; i < data_4.length; i++) {
                                            var opt = data_4[i];
                                            var el = document.createElement("option");
                                            el.textContent = opt;
                                            el.value = opt;
                                            select.appendChild(el);
                                        }
                                        $('#pincoded3').val("");

                                    });




                                });

   
   // ***********FIND NEAREST FACILITY FEATURE
   let healthFacility,
                                    $locate = $('#locate'),
                                    $body = $('body'),
                                    $findNearest = $('#find-nearest'),
                                    $setlocation = $('#setlocation'),
                                    $setbuffer = $('#setbuffer')

                                let currentPos = null;
                                let marker = null;
                                let oldMarker = null;
                                let facilityLayer = new L.featureGroup();
                                let oldLayer = null;

                                // YOUR LOCATION BUTTON
                                $locate.on('click', function(e) {
                                    if (oldMarker) {
                                        mymap.removeLayer(oldMarker);
                                        oldMarker = null;
                                    }
                                    if (oldLayer) {
                                        mymap.removeLayer(oldLayer);
                                        oldLayer = null;
                                        facilityLayer = new L.featureGroup();
                                    }
                                    // $status.html('finding your location');
                                    if (!navigator.geolocation) {
                                        alert("<p>Sorry, your browser does not support Geolocation</p>");
                                        return;
                                    }
                                    $body.removeClass('loaded');
                                    navigator.geolocation.getCurrentPosition(success, error);
                                });                              

  // YOUR LOCATION BUTTON
  $locate.on('click', function(e) {
                                    if (oldMarker) {
                                        mymap.removeLayer(oldMarker);
                                        oldMarker = null;
                                    }
                                    if (oldLayer) {
                                        mymap.removeLayer(oldLayer);
                                        oldLayer = null;
                                        facilityLayer = new L.featureGroup();
                                    }
                                    // $status.html('finding your location');
                                    if (!navigator.geolocation) {
                                        alert("<p>Sorry, your browser does not support Geolocation</p>");
                                        return;
                                    }
                                    $body.removeClass('loaded');
                                    navigator.geolocation.getCurrentPosition(success, error);
                                });

                                // SET LOCATION BUTTON
                                $setlocation.on('click', function(e) {
                                        mymap.on('dblclick', function(e) {
                                            currentPos = [e.latlng.lat, e.latlng.lng];
                                            if (oldMarker) {
                                                mymap.removeLayer(oldMarker);
                                                oldMarker = null;
                                            }
                                            if (oldLayer) {
                                                mymap.removeLayer(oldLayer);
                                                oldLayer = null;
                                                facilityLayer = new L.featureGroup();
                                            }

                                            if (oldhfbb) {
                                                mymap.removeLayer(oldhfbb);
                                                // oldhfbb = [];
                                                // healthFacilityInBB = null;
                                            }
                                            marker = new L.marker(currentPos).addTo(mymap);
                                            oldMarker = marker;
                                        });
                                    })
                                    // SET BUFFER
                                var slider = document.getElementById("myRange");
                                var output = document.getElementById("demo");
                                output.innerHTML = slider.value;

                                slider.oninput = function() {
                                        output.innerHTML = this.value;

                                        //<!-- mymap.removeLayer(circle); -->
                                    }
                                    //////// BUFFER
                                var circle = new L.circle();
                                let healthFacilityInBB = null;
                                let oldhfbb = [];
                                let oldhfbbObj = {};
                                let healthFacility1 = null;
                                let healthFacility2 = null;
                                
                                let getTodaysDate = () =>{
                                    var currentdate = new Date(); 
                                    var datetime = " " + currentdate.getDate() + "/"
                                                    + (currentdate.getMonth()+1)  + "/" 
                                                    + currentdate.getFullYear() + " @ "  
                                                    + currentdate.getHours() + ":"  
                                                    + currentdate.getMinutes() + ":" 
                                                    + currentdate.getSeconds();
                                    return datetime;
                                }
                               

                                function downloadBufferData(){
                                    let keys = Object.keys(activatedHealthFacility);
                                    let covidkeys = ["DCH", "DCHC", "DCCC"]
                                    let updatedKeys = []
                                    let flag = false;
                                    keys.map(k => {
                                    if (covidkeys.includes(k)){
                                        if(!flag){
                                        flag = true;
                                        updatedKeys.push(k)
                                        }
                                    }else{
                                        updatedKeys.push(k)
                                    }
                                    })

                                    updatedKeys.map(activatedLayers =>{
                                        let props = []
                                        let filename = activatedLayers;

                                        if(covidkeys.includes(filename)){
                                            filename = "Covid Facilities";
                                        }
                                        let feat = oldhfbbObj[activatedLayers]._layers
                                        for (x in feat){
                                            props.push(feat[x].feature.properties)
                                        }

                                        let csv = jsonToCSV(props);
                                        downloadCSV(filename + getTodaysDate() + ".csv",csv);
                                        dlAnchorElem.click();
                                    })
                                }

                                function jsonToCSV(jsonObject){
                                var json = jsonObject
                                var fields = Object.keys(json[0])
                                var replacer = function(key, value) { return value === null ? '' : value } 
                                var csv = json.map(function(row){
                                    return fields.map(function(fieldName){
                                    return JSON.stringify(row[fieldName], replacer)
                                    }).join(',')
                                })
                                    csv.unshift(fields.join(',')) // add header column
                                    csv = csv.join('\r\n');
                                return csv;
                                }

                                function downloadCSV(filename,csvVariable){
                                var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(csvVariable);
                                    dlAnchorElem = document.getElementById('downloadAnchorElem');
                                dlAnchorElem.setAttribute("href", dataStr);
                                dlAnchorElem.setAttribute("download", filename);
                                }

                                
                                $setbuffer.on('click', function(e) {
                                    if (oldhfbb) {
                                        mymap.removeLayer(circle);
                                        oldhfbb.forEach(layer => mymap.removeLayer(layer));
                                        // oldhfbb = null;
                                        healthFacilityInBB = null;
                                        healthFacility2 = null;
                                        healthFacility1 = null;
                                    }
                                    mymap.removeLayer(circle);

                                    var radius = (output.innerHTML) * 1000;
                                    var circleCenter = currentPos;
                                    var circleOptions = {
                                        color: 'red',
                                        fillColor: '#f03',
                                        fillOpacity: 0.1
                                    }
                                    circle = new L.circle(circleCenter, radius, circleOptions);
                                    circle.addTo(mymap);
                                    let keys = Object.keys(activatedHealthFacility);
                                    let k = '';
                                    keys.forEach((v, i) => {
                                            k = v;
                                            if (k === "Allo")
                                                querybufAllo(currentPos,k);
                                            if (k === 'Alt')
                                                querybufALt(currentPos,k);
                                            if (k === 'CHC')
                                                querybufCHC(currentPos,k);
                                            if (k === 'PHC')
                                                querybufPHC(currentPos,k);
                                            if (k === 'DCH' || k === 'DCHC' || k === 'DCCC')
                                                queryArog(currentPos,k);
                                            if (k === 'hospital' || k === 'subcenter' || k === 'mhu' || k === 'phc' || k === 'clinic' || k === 'phu' || k === 'ashu' || k === 'mobmedu' || k === 'hfwi' || k === 'mhi' || k === 'dc' || k === 'phrmcy' || k === 'optical' || k === 'delvry' || k === 'dropin' || k === 'dspnsry' || k === 'dropin' || k === 'othr')
                                                querybuf(currentPos,k);

                                        })
                                        //querybuf(currentPos);


                                });
                                var highlight = L.circleMarker()
                                    // let indstate = document.getElementById('indstate').value;


                                function querybuf(currentPos,typeoFFacility) {

                                    function onEachFeatureForPointBB(feature, layer) {
                                        const unavailable = '-';
                                        const updateDate = "India Hospitals";
                                        layer.bindPopup(`<table class = 'popupclass'>
                                            <tr><td>Name:</td><td> ${feature.properties.facltyname}</td></tr>
                                            <tr><td>Type:</td><td> ${feature.properties.facltytyp}</td></tr>
                                            <tr><td>Amenities:</td><td> ${feature.properties.amenities}</td></tr>
                                            <tr><td>Address:</td><td> ${feature.properties.address_te1}</td></tr>
                                            <tr><td>District:</td><td> ${feature.properties.district_g}</td></tr>
                                            <tr><td>State:</td><td> ${feature.properties.state_gen}</td></tr>
                                            <tr><td>Pin Code:</td><td> ${feature.properties.pincode_ge}</td></tr>
                                            <tr><td>Total Bed Count:</td><td> ${unavailable}</td></tr>
                                            <tr><td>Pin Code Accuracy (within area):</td><td> Yes</td></tr>
                                            <tr><td>Management:</td><td> ${unavailable}</td></tr>
                                            <tr><td>Food Arrangement:</td><td> ${unavailable}</td></tr>
                                            <tr><td>Email ID:</td><td> ${unavailable}</td></tr>
                                            <tr><td>Website:</td><td> ${unavailable}</td></tr>
                                            <tr><td>Phone number:</td><td> ${unavailable}</td></tr>
                                            <tr><td>Last updated:</td><td> 12th May 2020</td></tr>
                                            <tr><button type="button" class="btn btn-outline-dark" style="color:white;">
                                            <a style="color:white;text-decoration:none" href="https://ee.humanitarianresponse.info/x/#BLiUveaW">
                                                Click here for Correction/Feedbacks</a></button></tr>
                                            </table>`)
                                    }

                                    let keys = Object.keys(activatedHealthFacility)
                                    let query = ''
                                    keys.forEach((v, i) => {
                                        if (v === 'hospital' || v === 'subcenter' || v === 'mhu' || v === 'phc' || v === 'clinic' || v === 'phu' || v === 'ashu' || v === 'mobmedu' || v === 'hfwi' || v === 'mhi' || v === 'dc' || v === 'phrmcy' || v === 'optical' || v === 'delvry' || v === 'dropin' || v === 'dspnsry' || v === 'othr') {
                                            query += v + ">0.0"
                                            if (i != keys.length - 1) {
                                                query += " OR "
                                            }
                                        }

                                    })

                                    let rootUrl = 'https://geoserver2.communitygis.net/geoserver/geonode/ows';
                                    let bbOffset = output.innerHTML / 111;
                                    let options = {
                                        service: 'WFS',
                                        version: '1.0.0',
                                        request: 'GetFeature',
                                        outputFormat: 'application/json',
                                        typeName: 'geonode:cumulative_health_facility_till_2june',
                                        cql_filter: `BBOX(the_geom,${currentPos[1]-bbOffset},${currentPos[0]-bbOffset},${currentPos[1]+bbOffset},${currentPos[0]+bbOffset}) AND (${query})`,
                                        propertyName: 'the_geom,facltyname,facltytyp,address_te1,amenities,state_gen,district_g,pincode_ge,totbed,state_gen'
                                    };
                                    let parameters = L.Util.extend(options);
                                    cql_url = rootUrl + L.Util.getParamString(parameters);

                                    fetch(cql_url).then(
                                        function(response) {
                                            if (response.status !== 200) {
                                                console.log('Looks like there was a problem. Status Code: ' +
                                                    response.status);
                                                return;
                                            }
                                            response.json().then(function(geojsonData) {
                                                let healthFacilityBB = L.geoJson(geojsonData.features, {
                                                    pointToLayer: function(feature, latlng) {
                                                        return L.circleMarker(latlng, {
                                                            fillColor: "#07f2cf",
                                                            color: "#000",
                                                            weight: 8,
                                                            opacity: .3,
                                                            fillOpacity: 0.8
                                                        });
                                                    },
                                                    onEachFeature: onEachFeatureForPointBB,
                                                }).addTo(mymap);
                                                oldhfbbObj[typeoFFacility] = healthFacilityBB;
                                                oldhfbb.push(healthFacilityBB);
                                            });


                                        }).catch(function(err) {
                                        console.log('Fetch Error :-S', err);
                                    });



                                }




</script>


<script>

    document.addEventListener('DOMContentLoaded', () => {
        var elems = document.querySelectorAll('.modal');
        var instances = M.Modal.init(elems, {opacity:.3});
    });
    
    </script>
    

{% endblock %}
